
### Testing Orders API

- It needs **PORT-FORWARDING** for the **nats** service:
    ```bash
    # On the host
    bash port-forward-nats.sh
    # Test the port-forwarding in the host
    export NATS_URL="nats://localhost:4222" 
    nats str ls
    ```
- Check the **model** *ticket* in the Orders Api before run the test, it must be empty. Run the 
  script:
  ```bash
  bash stress-testing/testing_orders_api/script.sh   
  ```
- This test create a ticket and updated three times, its goals is to test the performance of the 
API and the correctness of the data, because of race conditions and concurrency some events
with lower version that the current version can arrive first, the API should nack those events.

- The perfect result is the db with the last versions of all the events.
- The ids generated by the script must be unique, test the ids uniqueness with the following command:
    ```bash
    # this command filters out the unique lines and displays only those lines that 
    # have a count greater than 1, indicating duplicate occurrences.
    sort ids.test.csv | uniq -c | awk '$1 > 1'
    # show only the duplicate ids
    sort ids.test.csv | uniq -d
    ```

**WARNING**: The db it must be deleted before run this test. Orders API Ticket model is 
the replica of the Ticket model in the Ticket Service, the Ticket API Service versions the 
Ticket Model.

```bash
db_orders=$(kubectl get pods -l db=orders -o jsonpath="{.items[0].metadata.name}")

kubectl exec -it "$db_orders" -- psql -U jorge -d orders -t -c 'SELECT COUNT(*) FROM "ticket" WHERE "version" <> 3;' -q
# 0 rows
kubectl exec -it "$db_orders" -- psql -U jorge -d orders -t -c 'SELECT COUNT(*) FROM "ticket" WHERE "version" = 3;' -q
# n rows 
kubectl exec -it "$db_orders" -- psql -U jorge -d orders -t -c 'DELETE FROM "ticket";' -q
```